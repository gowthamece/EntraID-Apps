@page "/fido-provisioning"
@using FIDO_User_Provisioing.Models
@using FIDO_User_Provisioing.Services
@using Microsoft.FluentUI.AspNetCore.Components
@inject IFido2ProvisioningService Fido2Service
@inject IJSRuntime JSRuntime
@inject ILogger<FidoProvisioning> Logger
@rendermode InteractiveServer

<PageTitle>FIDO2 Security Key Provisioning</PageTitle>

<FluentCard>
    <h1>FIDO2 Security Key Provisioning</h1>
    <p>Manage FIDO2 security keys for users to enable passwordless authentication.</p>
</FluentCard>

<FluentCard class="mt-4">
    <h3>Search Users</h3>
    <FluentGrid>
        <FluentGridItem xs="12" md="8">
            <FluentTextField @bind-Value="searchTerm" 
                           Placeholder="Search by name, email, or UPN..."
                           style="width: 100%;" />
        </FluentGridItem>
        <FluentGridItem xs="12" md="4">
            <FluentButton @onclick="SearchUsers" Appearance="Appearance.Accent">
                ?? Search
            </FluentButton>
        </FluentGridItem>
    </FluentGrid>

    @if (searchResults.Any())
    {
        <FluentDataGrid Items="@searchResults.AsQueryable()" class="mt-3">
            <PropertyColumn Property="@(u => u.DisplayName)" Title="Display Name" />
            <PropertyColumn Property="@(u => u.UserPrincipalName)" Title="User Principal Name" />
            <PropertyColumn Property="@(u => u.Mail)" Title="Email" />
            <TemplateColumn Title="Actions">
                <FluentButton @onclick="@(() => SelectUser(context))" Appearance="Appearance.Accent">
                    ?? Select
                </FluentButton>
            </TemplateColumn>
        </FluentDataGrid>
    }
</FluentCard>

@if (selectedUser != null)
{
    <FluentCard class="mt-4">
        <h3>Selected User: @selectedUser.DisplayName</h3>
        <p><strong>UPN:</strong> @selectedUser.UserPrincipalName</p>
        <p><strong>Email:</strong> @selectedUser.Mail</p>

        <FluentTabs>
            <FluentTab Text="Existing FIDO2 Keys">
                <div class="mt-3">
                    @if (isLoadingMethods)
                    {
                        <FluentProgressRing />
                        <span>Loading FIDO2 methods...</span>
                    }
                    else if (userFido2Methods.Any())
                    {
                        <FluentDataGrid Items="@userFido2Methods.AsQueryable()">
                            <PropertyColumn Property="@(m => m.DisplayName)" Title="Display Name" />
                            <PropertyColumn Property="@(m => m.Model)" Title="Model" />
                            <PropertyColumn Property="@(m => m.CreatedDateTime)" Title="Created" Format="yyyy-MM-dd HH:mm" />
                            <PropertyColumn Property="@(m => m.AttestationLevel)" Title="Attestation Level" />
                            <TemplateColumn Title="Actions">
                                <FluentButton @onclick="@(() => DeleteFido2Key(context.Id!))"
                                            Appearance="Appearance.Stealth"
                                            style="color: red;">
                                    ??? Delete
                                </FluentButton>
                            </TemplateColumn>
                        </FluentDataGrid>
                    }
                    else
                    {
                        <FluentMessageBar Intent="@MessageIntent.Info">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>No FIDO2 security keys found for this user.</span>
                                <FluentButton @onclick="@QuickProvisionKey" 
                                            Appearance="Appearance.Accent"
                                            Disabled="@isProvisioning"
                                            style="margin-left: 10px;">
                                    @if (isProvisioning)
                                    {
                                        <FluentProgressRing style="width: 16px; height: 16px;" />
                                        <span>Provisioning...</span>
                                    }
                                    else
                                    {
                                        <span>ðŸ”‘ Quick Provision</span>
                                    }
                                </FluentButton>
                            </div>
                        </FluentMessageBar>
                    }
                </div>
            </FluentTab>

            <FluentTab Text="Provision New Key">
                <div class="mt-3">
                    <EditForm Model="@provisioningRequest" OnValidSubmit="@ProvisionNewKey">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <FluentGrid>
                            <FluentGridItem xs="12" md="6">
                                <FluentTextField @bind-Value="provisioningRequest.DisplayName" 
                                               Label="Display Name" 
                                               Required="true"
                                               style="width: 100%;" />
                            </FluentGridItem>
                            <FluentGridItem xs="12" md="6">
                                <FluentTextField @bind-Value="provisioningRequest.Model" 
                                               Label="Security Key Model (Optional)"
                                               style="width: 100%;" />
                            </FluentGridItem>
                            <FluentGridItem xs="12" md="6">
                                <FluentNumberField @bind-Value="provisioningRequest.AttestationLevel" 
                                                 Label="Attestation Level"
                                                 Min="1" Max="3"
                                                 style="width: 100%;" />
                            </FluentGridItem>
                            <FluentGridItem xs="12" md="6">
                                <FluentCheckbox @bind-Value="provisioningRequest.IsBackupEligible" 
                                              Label="Is Backup Eligible" />
                            </FluentGridItem>
                            <FluentGridItem xs="12">
                                <FluentButton Type="ButtonType.Submit" 
                                            Appearance="Appearance.Accent"
                                            Disabled="@isProvisioning">
                                    @if (isProvisioning)
                                    {
                                        <FluentProgressRing style="width: 16px; height: 16px;" />
                                        <span>Provisioning...</span>
                                    }
                                    else
                                    {
                                        <span>?? Provision FIDO2 Key</span>
                                    }
                                </FluentButton>
                            </FluentGridItem>
                        </FluentGrid>
                    </EditForm>
                </div>
            </FluentTab>
        </FluentTabs>
    </FluentCard>
}

@if (!string.IsNullOrEmpty(message))
{
    <FluentCard class="mt-4">
        <FluentMessageBar Intent="@(isError ? MessageIntent.Error : MessageIntent.Success)">
            @message
        </FluentMessageBar>
    </FluentCard>
}

@code {
    private string searchTerm = string.Empty;
    private List<UserSearchResult> searchResults = new();
    private UserSearchResult? selectedUser;
    private List<Fido2AuthenticationMethod> userFido2Methods = new();
    private Fido2ProvisioningRequest provisioningRequest = new();
    private bool isLoadingMethods = false;
    private bool isProvisioning = false;
    private string message = string.Empty;
    private bool isError = false;

    private async Task SearchUsers()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            ShowMessage("Please enter a search term.", true);
            return;
        }

        try
        {
            searchResults.Clear();
            var results = await Fido2Service.SearchUsersAsync(searchTerm);
            searchResults.AddRange(results);
            
            if (!searchResults.Any())
            {
                ShowMessage("No users found matching the search criteria.", true);
            }
            else
            {
                ClearMessage();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error searching users");
            ShowMessage($"Error searching users: {ex.Message}", true);
        }
    }

    private async Task SelectUser(UserSearchResult user)
    {
        selectedUser = user;
        provisioningRequest.UserPrincipalName = user.UserPrincipalName;
        await LoadUserFido2Methods();
    }

    private async Task LoadUserFido2Methods()
    {
        if (selectedUser == null) return;

        isLoadingMethods = true;
        try
        {
            userFido2Methods.Clear();
            var methods = await Fido2Service.GetUserFido2MethodsAsync(selectedUser.Id);
            userFido2Methods.AddRange(methods);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading FIDO2 methods for user {UserId}", selectedUser.Id);
            ShowMessage($"Error loading FIDO2 methods: {ex.Message}", true);
        }
        finally
        {
            isLoadingMethods = false;
        }
    }

    private async Task ProvisionNewKey()
    {
        if (selectedUser == null) return;

        isProvisioning = true;
        try
        {
            var response = await Fido2Service.ProvisionFido2KeyAsync(selectedUser.Id, provisioningRequest);
            
            if (response.Success)
            {
                ShowMessage(response.Message ?? "FIDO2 key provisioning initiated successfully.", false);
                // Reset the form
                provisioningRequest = new Fido2ProvisioningRequest 
                { 
                    UserPrincipalName = selectedUser.UserPrincipalName 
                };
                // Refresh the methods list
                await LoadUserFido2Methods();
            }
            else
            {
                ShowMessage(response.Error ?? "Error provisioning FIDO2 key.", true);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error provisioning FIDO2 key for user {UserId}", selectedUser.Id);
            ShowMessage($"Error provisioning FIDO2 key: {ex.Message}", true);
        }
        finally
        {
            isProvisioning = false;
        }
    }

    private async Task DeleteFido2Key(string methodId)
    {
        if (selectedUser == null) return;

        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this FIDO2 security key?");
        if (!confirmed) return;

        try
        {
            var response = await Fido2Service.DeleteFido2KeyAsync(selectedUser.Id, methodId);
            
            if (response.Success)
            {
                ShowMessage(response.Message ?? "FIDO2 key deleted successfully.", false);
                await LoadUserFido2Methods();
            }
            else
            {
                ShowMessage(response.Error ?? "Error deleting FIDO2 key.", true);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting FIDO2 key {MethodId} for user {UserId}", methodId, selectedUser.Id);
            ShowMessage($"Error deleting FIDO2 key: {ex.Message}", true);
        }
    }

    private void ShowMessage(string msg, bool error)
    {
        message = msg;
        isError = error;
        StateHasChanged();
    }

    private void ClearMessage()
    {
        message = string.Empty;
        isError = false;
    }

    private async Task QuickProvisionKey()
    {
        if (selectedUser == null) return;

        isProvisioning = true;
        try
        {
            // Create a quick provisioning request with default values
            var quickRequest = Fido2Service.CreateQuickProvisioningRequest(
                selectedUser.UserPrincipalName, 
                selectedUser.DisplayName);

            var response = await Fido2Service.ProvisionFido2KeyAsync(selectedUser.Id, quickRequest);
            
            if (response.Success)
            {
                ShowMessage($"âœ… {response.Message}", false);
                
                // Also set up the provisioning form with the same values for manual completion if needed
                provisioningRequest = quickRequest;
                
                // Refresh the methods list
                await LoadUserFido2Methods();
                
                // Show instructions for completing the setup
                await ShowProvisioningInstructions();
            }
            else
            {
                ShowMessage($"âŒ {response.Error ?? "Error provisioning FIDO2 key."}", true);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in quick provisioning FIDO2 key for user {UserId}", selectedUser.Id);
            ShowMessage($"âŒ Error provisioning FIDO2 key: {ex.Message}", true);
        }
        finally
        {
            isProvisioning = false;
        }
    }

    private async Task ShowProvisioningInstructions()
    {
        var instructions = @"
ðŸ”‘ FIDO2 Key Provisioning Instructions:

1. Have the user insert their FIDO2 security key into a USB port or ensure it's connected via NFC/Bluetooth
2. The user will need to complete the registration on their device through a web browser
3. They should visit the Microsoft MyAccount portal (account.microsoft.com)
4. Navigate to Security > Sign-in options > Security key
5. Follow the on-screen prompts to complete the registration
6. The user may need to touch their security key or enter their PIN when prompted

Note: The actual key binding happens during the user's next authentication attempt or through the MyAccount portal.
        ";

        await JSRuntime.InvokeVoidAsync("alert", instructions);
    }
}